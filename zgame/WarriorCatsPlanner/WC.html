<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WolfLight â€” Warrior Cats Planner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Dynapuff&display=swap');

  /* Reset and base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Dynapuff', cursive;
    background: #121212;
    color: white;
  -webkit-user-select: none;
    user-select: none;
  }

  header {
    background: #1a1a1a;
    padding: 12px 16px;
    font-size: 1.8rem;
    text-align: center;
    letter-spacing: 2px;
    text-transform: uppercase;
    border-bottom: 3px solid #2a9d8f;
  }

  .toolbar {
    display: flex;
    justify-content: space-between;
    padding: 10px 20px;
    background: #1a1a1a;
    border-bottom: 3px solid #b697c2;
  }

  .toolbar button {
    background: #1a1a1a;
    color: white;
    border: 2px solid #2a9d8f;
    padding: 8px 16px;
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.3s ease, color 0.3s ease;
  }
  .toolbar button:hover {
    background: #2a9d8f;
    color: #121212;
  }

  .container {
    padding: 15px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
  }

  .clan-card {
    background: #1a1a1a;
    border: 2px solid #2a9d8f;
    border-radius: 10px;
    width: 320px;
    box-shadow: 0 0 10px #2a9d8f44;
    display: flex;
    flex-direction: column;
    animation: fadeInUp 0.5s ease forwards;
  }

  .clan-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 2px solid #b697c2;
  }
  .clan-header img {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 12px;
  }
  .clan-header h2 {
    flex-grow: 1;
    font-size: 1.3rem;
    margin: 0;
  }

  .clan-description {
    padding: 0 16px 12px 16px;
    font-size: 0.9rem;
    color: #b697c2;
  }

  /* Cat descriptions (living, dead, unborn) */
  .cat-description,
  .dead-description,
  .unborn-description {
    font-size: 0.85rem;
    color: #b697c2;
    margin-top: 2px;
  }

  .cats-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 0 16px 16px 16px;
  }

  .cat-item {
    display: flex;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #2a9d8f44;
  }
  .cat-item:last-child {
    border-bottom: none;
  }
  /* Drag & drop visuals */
  .cat-item.dragging {
    opacity: 0.5;
  }
  .cat-item.drag-over {
    background: rgba(42, 157, 143, 0.15);
  }
  .cats-list.drop-target {
    outline: 2px dashed #2a9d8f;
    outline-offset: 4px;
  }

  .cat-item img {
    width: 36px;
    height: 36px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 10px;
    flex-shrink: 0;
  }
  .cat-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  .cat-name {
    font-weight: 700;
    font-size: 1rem;
  }
  .cat-rank-age {
    font-size: 0.8rem;
    color: #b697c2;
  }

  .cat-item button {
    background: #1a1a1a;
    border: 1.5px solid #b697c2;
    color: white;
    padding: 4px 10px;
    font-size: 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
    flex-shrink: 0;
  }
  .cat-item button:hover {
    background: #b697c2;
    color: #121212;
  }

  .clan-card > button.add-cat-btn {
    background: #2a9d8f;
    border: none;
    color: white;
    font-weight: 600;
    border-radius: 0 0 10px 10px;
    padding: 10px 0;
    cursor: pointer;
    letter-spacing: 1.3px;
    font-size: 1rem;
    transition: background 0.3s ease;
  }
  .clan-card > button.add-cat-btn:hover {
    background: #b697c2;
    color: #121212;
  }

  .clan-card > .clan-footer {
    padding: 8px 16px;
    border-top: 2px solid #b697c2;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  .clan-card > .clan-footer button {
    background: #1a1a1a;
    border: 2px solid #b697c2;
    color: white;
    padding: 6px 14px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .clan-card > .clan-footer button:hover {
    background: #b697c2;
    color: #121212;
  }

  details {
    margin: 20px;
    border: 2px solid #2a9d8f;
    border-radius: 10px;
    background: #1a1a1a;
    color: #b697c2;
    box-shadow: 0 0 10px #2a9d8f44;
    animation: fadeIn 0.5s ease forwards;
  }
  summary {
    font-size: 1.3rem;
    font-weight: 700;
    cursor: pointer;
    padding: 12px 16px;
    user-select: none;
  }
  summary::-webkit-details-marker {
    display: none;
  }

  #deadCatsContainer {
    padding: 12px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    justify-content: center;
  }
  #unbornCatsContainer {
    padding: 12px 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    justify-content: center;
  }

  .dead-card {
    background: #1a1a1a;
    border: 2px solid #b697c2;
    border-radius: 10px;
    width: 280px;
    padding: 10px 14px;
    box-shadow: 0 0 8px #b697c244;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .dead-card img {
    width: 44px;
    height: 44px;
    border-radius: 6px;
    object-fit: cover;
    flex-shrink: 0;
  }
  .dead-info {
    flex-grow: 1;
  }
  .dead-name {
    font-weight: 700;
    font-size: 1rem;
    color: white;
  }
  .dead-rank-age {
    font-size: 0.85rem;
    color: #b697c2;
  }
  .dead-age-deathage {
    font-size: 0.75rem;
    color: #999;
  }

  .dead-card button {
    background: #1a1a1a;
    border: 2px solid #b697c2;
    color: white;
    padding: 6px 12px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .dead-card button:hover {
    background: #b697c2;
    color: #121212;
  }

  .unborn-card {
    background: #1a1a1a;
    border: 2px solid #2a9d8f;
    border-radius: 10px;
    width: 280px;
    padding: 10px 14px;
    box-shadow: 0 0 8px #2a9d8f44;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .unborn-card img {
    width: 44px;
    height: 44px;
    border-radius: 6px;
    object-fit: cover;
    flex-shrink: 0;
  }
  .unborn-info {
    flex-grow: 1;
  }
  .unborn-name {
    font-weight: 700;
    font-size: 1rem;
    color: white;
  }
  .unborn-age {
    font-size: 0.85rem;
    color: #b697c2;
  }
  .unborn-card button {
    background: #1a1a1a;
    border: 2px solid #2a9d8f;
    color: white;
    padding: 6px 12px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .unborn-card button:hover {
    background: #2a9d8f;
    color: #121212;
  }

  /* Modal base */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .modal-overlay.show {
    opacity: 1;
    pointer-events: auto;
  }
  .modal {
    background: #121212;
    border: 2px solid #2a9d8f;
    border-radius: 12px;
    width: 380px;
    max-width: 95vw;
    padding: 20px 24px 24px 24px;
    box-shadow: 0 0 15px #2a9d8faa;
    color: white;
    animation: scaleFadeIn 0.3s ease forwards;
  }
  .modal h3 {
    margin-top: 0;
    margin-bottom: 16px;
    text-align: center;
    letter-spacing: 1.4px;
  }
  .modal label {
    display: block;
    font-weight: 700;
    margin-bottom: 6px;
    color: #b697c2;
  }
  .modal input[type="text"],
  .modal input[type="number"],
  .modal textarea,
  .modal select {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 14px;
    border-radius: 6px;
    border: 2px solid #2a9d8f;
    background: #1a1a1a;
    color: white;
    font-weight: 700;
    font-family: 'Dynapuff', cursive;
    font-size: 1rem;
    letter-spacing: 1.2px;
  }
  .modal textarea {
    resize: vertical;
  }

  .modal select {
    color: black !important;
    font-weight: 700;
  }

  .modal .img-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    max-height: 160px;
    overflow-y: auto;
    margin-bottom: 14px;
  }
  .modal .img-picker img {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: border-color 0.3s ease;
  }
  .modal .img-picker img.selected {
    border-color: #2a9d8f;
  }

  /* Upload button row inside modals */
  .modal .img-upload {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
  }
  .modal .img-upload button {
    background: #1a1a1a;
    border: 2px solid #2a9d8f;
    color: white;
    padding: 8px 16px;
    font-weight: 700;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: background 0.3s ease;
  }
  .modal .img-upload button:hover {
    background: #2a9d8f;
    color: #121212;
  }

  .modal-buttons {
    display: flex;
    justify-content: space-between;
  }
  .modal-buttons button {
    background: #1a1a1a;
    border: 2px solid #2a9d8f;
    color: white;
    padding: 8px 16px;
    font-weight: 700;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: background 0.3s ease;
  }
  .modal-buttons button:hover {
    background: #2a9d8f;
    color: #121212;
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    right: 16px;
    top: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1300;
    pointer-events: none;
  }
  .toast {
    min-width: 220px;
    max-width: 360px;
    background: #1a1a1a;
    border-left: 4px solid #2a9d8f;
    box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    border-radius: 8px;
    color: white;
    padding: 10px 12px;
    font-weight: 700;
    letter-spacing: 0.6px;
    animation: fadeIn 0.2s ease;
    pointer-events: auto;
  }
  .toast.success { border-left-color: #2a9d8f; }
  .toast.info { border-left-color: #b697c2; }
  .toast.warning { border-left-color: #e0a800; }
  .toast.error { border-left-color: #d94f4f; }
  .toast .toast-close {
    float: right;
    background: transparent;
    border: none;
    color: #bbb;
    cursor: pointer;
    font-size: 1rem;
  }

  /* Confirm modal (separate overlay to avoid clashing with edit modals) */
  #confirmOverlay.modal-overlay { z-index: 1250; }
  .confirm-modal {
    background: #121212;
    border: 2px solid #b697c2;
    border-radius: 12px;
    width: 420px;
    max-width: 95vw;
    padding: 18px 20px 16px 20px;
    box-shadow: 0 0 15px #b697c2aa;
    color: white;
  }
  .confirm-text { margin: 0 0 14px 0; color: #bfbfbf; }
  .confirm-buttons { display: flex; gap: 10px; justify-content: flex-end; }
  .confirm-buttons button {
    background: #1a1a1a;
    border: 2px solid #b697c2;
    color: white;
    padding: 6px 14px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .confirm-buttons button:hover { background: #b697c2; color: #121212; }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @keyframes scaleFadeIn {
    from {
      opacity: 0;
      transform: scale(0.85);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  @keyframes fadeIn {
    from {opacity:0}
    to {opacity:1}
  }

  /* Scrollbar for cats list */
  .cats-list::-webkit-scrollbar {
    width: 8px;
  }
  .cats-list::-webkit-scrollbar-track {
    background: #121212;
  }
  .cats-list::-webkit-scrollbar-thumb {
    background: #2a9d8f;
    border-radius: 6px;
  }
</style>
</head>
<body>

<header>WolfLight â€” Warrior Cats Planner</header>

<div class="toolbar">
  <button id="addClanBtn">+ Add Clan</button>
  <div>
  <button id="ageUpBtn" title="Make all cats one moon older">+1 moon</button>
  <button id="ageDownBtn" title="Make all cats one moon younger">-1 moon</button>
    <button id="saveBtn">ðŸ’¾ Save</button>
    <button id="loadBtn">ðŸ“‚ Load</button>
    <button id="copyBtn">ðŸ“‹ Copy Allegiances</button>
  <button id="copyBookBtn" title="Copy book-style allegiances">ðŸ“š Copy Book-Style</button>
  </div>
</div>

<div class="container" id="clansContainer">
  <!-- Clans will appear here -->
</div>

<details>
  <summary>Dead Cats</summary>
  <div class="container" id="deadCatsContainer">
    <!-- Dead cats here -->
  </div>
</details>

<!-- Toasts -->
<div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<!-- Confirm Overlay -->
<div class="modal-overlay" id="confirmOverlay" tabindex="-1" aria-hidden="true">
  <div class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <!-- Content dynamically injected -->
  </div>
  </div>

<details>
  <summary>Unborn Cats</summary>
  <div class="container" id="unbornCatsContainer">
    <!-- Unborn cats here -->
  </div>
</details>

<!-- Modal Overlay -->
<div class="modal-overlay" id="modalOverlay" tabindex="-1" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">

    <!-- Content dynamically injected -->

  </div>
</div>

<script>
  // Data models
  let clans = [];
  let deadCats = [];
  let unbornCats = [];

  // DOM refs
  const clansContainer = document.getElementById('clansContainer');
  const deadCatsContainer = document.getElementById('deadCatsContainer');
  const unbornCatsContainer = document.getElementById('unbornCatsContainer');
  const modalOverlay = document.getElementById('modalOverlay');
  const modal = modalOverlay.querySelector('.modal');
  const toastContainer = document.getElementById('toastContainer');
  const confirmOverlay = document.getElementById('confirmOverlay');
  const confirmModal = confirmOverlay.querySelector('.confirm-modal');

  // Helpers for image selection for clans and cats (placeholder icons)
  const clanImages = [
  'Clan logos/blank (1).png',
  'Clan logos/Riverclan (1).png',
  'Clan logos/shadowclan (1).png',
  'Clan logos/skyclan (1).png',
  'Clan logos/starclan (1).png',
  'Clan logos/thunderclan (1).png',
  'Clan logos/Windclan (1).png',
  ];
  const catImages = [
  'Cat photos/blackcat1.jpg',
  'Cat photos/browncat1.jpg',
  'Cat photos/calicofluffy1.jpg',
  'Cat photos/calicokittenfluffy1.jpg',
  'Cat photos/fluffygingercat2.jpg',
  'Cat photos/fluffygreycat1.jpg',
  'Cat photos/gingercat1.jpg',
  'Cat photos/gingercat2.jpg',
  'Cat photos/gingerfluffy1.jpg',
  'Cat photos/gingerkittenfluffy.jpg',
  'Cat photos/grey1.jpg',
  'Cat photos/tortoiseshell1.jpg',
  'Cat photos/tortoiseshellkitten1.jpg',
  'Cat photos/white1.jpg',
  'Cat photos/whitefluffy.jpg',
  ];

  // Save/load from localStorage
  function saveData() {
    localStorage.setItem('warriorCatsPlannerClans', JSON.stringify(clans));
    localStorage.setItem('warriorCatsPlannerDeadCats', JSON.stringify(deadCats));
  localStorage.setItem('warriorCatsPlannerUnbornCats', JSON.stringify(unbornCats));
  showToast('Data saved!', 'success');
  }
  function loadData() {
    const loadedClans = JSON.parse(localStorage.getItem('warriorCatsPlannerClans'));
    const loadedDead = JSON.parse(localStorage.getItem('warriorCatsPlannerDeadCats'));
  const loadedUnborn = JSON.parse(localStorage.getItem('warriorCatsPlannerUnbornCats'));
    clans = Array.isArray(loadedClans) ? loadedClans : [];
    deadCats = Array.isArray(loadedDead) ? loadedDead : [];
  unbornCats = Array.isArray(loadedUnborn) ? loadedUnborn : [];
    renderAll();
  showToast('Data loaded!', 'info');
  }

  // ===== Named Saves (multiple slots) =====
  const SAVES_INDEX_KEY = 'warriorCatsPlannerSavesIndex';
  const SAVE_PREFIX = 'warriorCatsPlannerSave:';

  function getSavesIndex() {
    try {
      const raw = localStorage.getItem(SAVES_INDEX_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function setSavesIndex(index) {
    localStorage.setItem(SAVES_INDEX_KEY, JSON.stringify(index));
  }
  function makeId() {
    return 's-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 7);
  }
  function snapshotData() {
    return {
      clans: JSON.parse(JSON.stringify(clans)),
      deadCats: JSON.parse(JSON.stringify(deadCats)),
      unbornCats: JSON.parse(JSON.stringify(unbornCats)),
    };
  }
  function saveNamed(name, overwriteId = null) {
    const index = getSavesIndex();
    const now = Date.now();
    const id = overwriteId || makeId();
    const entry = { id, name, ts: now };
    localStorage.setItem(SAVE_PREFIX + id, JSON.stringify(snapshotData()));
    if (overwriteId) {
      const i = index.findIndex(e => e.id === overwriteId);
      if (i >= 0) index[i] = entry; else index.unshift(entry);
    } else {
      index.unshift(entry);
    }
    setSavesIndex(index);
    return entry;
  }
  function loadNamed(id) {
    const raw = localStorage.getItem(SAVE_PREFIX + id);
    if (!raw) return false;
    try {
      const data = JSON.parse(raw);
      clans = Array.isArray(data.clans) ? data.clans : [];
      deadCats = Array.isArray(data.deadCats) ? data.deadCats : [];
      unbornCats = Array.isArray(data.unbornCats) ? data.unbornCats : [];
      renderAll();
      return true;
    } catch { return false; }
  }
  function deleteNamed(id) {
    const index = getSavesIndex().filter(e => e.id !== id);
    setSavesIndex(index);
    localStorage.removeItem(SAVE_PREFIX + id);
  }
  function formatDate(ts) {
    const d = new Date(ts);
    const pad = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // Save modal (named)
  function openSaveModal() {
    modalMode = 'namedSave';
    const suggested = `Save â€” ${formatDate(Date.now())}`;
    const existing = getSavesIndex();
    modal.innerHTML = `
      <h3 id="modalTitle">Save Game</h3>
      <label for="saveName">Save name</label>
      <input type="text" id="saveName" value="${escapeHtml(suggested)}" placeholder="Enter a name" required />
      <div style="max-height:150px; overflow:auto; border:1px solid #2a9d8f; border-radius:6px; padding:8px; margin-bottom:12px;">
        <div style="color:#b697c2; font-weight:700; margin-bottom:6px;">Existing saves</div>
        <ul id="savesList" style="list-style:none; padding-left:0; margin:0;"></ul>
      </div>
      <div class="modal-buttons">
        <button id="saveDoBtn">Save</button>
        <button id="saveCancelBtn">Cancel</button>
      </div>
    `;
    const list = modal.querySelector('#savesList');
    existing.forEach(e => {
      const li = document.createElement('li');
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.alignItems = 'center';
      li.style.padding = '4px 0';
      li.innerHTML = `<span>${escapeHtml(e.name)}</span><span style="color:#777; font-size:0.85rem;">${formatDate(e.ts)}</span>`;
      list.appendChild(li);
    });
    modal.querySelector('#saveDoBtn').onclick = async () => {
      const name = modal.querySelector('#saveName').value.trim();
      if (!name) { showToast('Save name is required.', 'error'); return; }
      const idx = getSavesIndex();
      const dup = idx.find(e => e.name.toLowerCase() === name.toLowerCase());
      if (dup) {
        const ok = await uiConfirm(`A save named "${name}" exists. Overwrite?`, { okText: 'Overwrite' });
        if (!ok) return;
        saveNamed(name, dup.id);
        showToast('Save overwritten.', 'success');
      } else {
        saveNamed(name);
        showToast('Saved.', 'success');
      }
      closeModal();
    };
    modal.querySelector('#saveCancelBtn').onclick = closeModal;
    openModal();
  }

  // Load modal (select named save, or blank)
  function openLoadModal() {
    modalMode = 'namedLoad';
    const existing = getSavesIndex();
    modal.innerHTML = `
      <h3 id="modalTitle">Load Game</h3>
      <div class="modal-buttons" style="justify-content:flex-start; margin-bottom:10px;">
        <button id="loadBlankBtn">Load Blank</button>
      </div>
      <div style="max-height:280px; overflow:auto; border:1px solid #2a9d8f; border-radius:6px; padding:8px;">
        <ul id="loadSavesList" style="list-style:none; padding-left:0; margin:0;"></ul>
      </div>
      <div class="modal-buttons">
        <button id="loadCloseBtn">Close</button>
      </div>
    `;
    const list = modal.querySelector('#loadSavesList');
    if (existing.length === 0) {
      const empty = document.createElement('div');
      empty.style.color = '#b697c2';
      empty.textContent = 'No saves yet.';
      list.appendChild(empty);
    } else {
      existing.forEach(e => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.gap = '8px';
        li.style.alignItems = 'center';
        li.style.padding = '6px 0';
        const info = document.createElement('div');
        info.style.flex = '1';
        info.innerHTML = `<div style="font-weight:700;">${escapeHtml(e.name)}</div><div style="color:#777; font-size:0.85rem;">${formatDate(e.ts)}</div>`;
        const loadBtn = document.createElement('button');
        loadBtn.textContent = 'Load';
        loadBtn.onclick = () => {
          const ok = loadNamed(e.id);
          if (ok) { showToast(`Loaded: ${e.name}`, 'info'); closeModal(); }
          else { showToast('Failed to load save.', 'error'); }
        };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.borderColor = '#d94f4f';
        delBtn.style.color = '#d94f4f';
        delBtn.onmouseenter = () => { delBtn.style.background = '#d94f4f'; delBtn.style.color = '#121212'; };
        delBtn.onmouseleave = () => { delBtn.style.background = 'transparent'; delBtn.style.color = '#d94f4f'; };
        delBtn.onclick = async () => {
          const ok = await uiConfirm(`Delete save "${e.name}"?`, { okText: 'Delete' });
          if (!ok) return;
          deleteNamed(e.id);
          showToast('Save deleted.', 'warning');
          openLoadModal(); // refresh list
        };
        li.appendChild(info);
        li.appendChild(loadBtn);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }
    modal.querySelector('#loadBlankBtn').onclick = () => {
      clans = [];
      deadCats = [];
      unbornCats = [];
      renderAll();
      showToast('Loaded blank state.', 'info');
      closeModal();
    };
    modal.querySelector('#loadCloseBtn').onclick = closeModal;
    openModal();
  }

  // Copy allegiances text (clan names and cats)
  function copyAllegiances() {
    const clean = (s) => (s || '').replace(/\s+/g, ' ').trim();
    let text = '';
    clans.forEach(clan => {
      text += `Clan: ${clan.name}\n`;
      const cDesc = clean(clan.description);
      if (cDesc) text += `Description: ${cDesc}\n`;
      clan.cats.forEach(cat => {
        const catDesc = clean(cat.description);
        const base = ` - ${cat.name} (${cat.rank}, age: ${cat.age})`;
        text += catDesc ? `${base} â€” ${catDesc}\n` : `${base}\n`;
      });
      text += '\n';
    });
    if (text.trim() === '') {
      text = '(No clans or cats)';
    }
    navigator.clipboard.writeText(text).then(() => {
      showToast('Allegiances copied to clipboard!', 'success');
    }).catch(() => {
      showToast('Failed to copy â€” try again.', 'error');
    });
  }

  // Copy book-style allegiances (grouped by roles like the books)
  function copyAllegiancesBookStyle() {
  const norm = (s) => (s || '').toLowerCase();
  const clean = (s) => (s || '').replace(/\s+/g, ' ').trim();
    const categorize = (rank) => {
      const r = norm(rank);
      if (r.includes('leader')) return 'leader';
      if (r.includes('deputy')) return 'deputy';
      if (r.includes('medicine') && r.includes('apprentice')) return 'medApp';
      if (r.includes('medicine')) return 'med';
      if (r.includes('queen')) return 'queens';
      if (r.includes('elder')) return 'elders';
      if (r.includes('kit')) return 'kits';
      if (r.includes('apprentice')) return 'apprentices';
      if (r.includes('warrior')) return 'warriors';
      // default bucket for unknown ranks
      return 'warriors';
    };
    const header = (key, count) => {
      switch (key) {
        case 'leader': return count > 1 ? 'Leaders' : 'Leader';
        case 'deputy': return count > 1 ? 'Deputies' : 'Deputy';
        case 'med': return count > 1 ? 'Medicine cats' : 'Medicine cat';
        case 'medApp': return count > 1 ? 'Medicine cat apprentices' : 'Medicine cat apprentice';
        case 'warriors': return 'Warriors';
        case 'apprentices': return 'Apprentices';
        case 'queens': return 'Queens';
        case 'elders': return 'Elders';
        case 'kits': return 'Kits';
        default: return key;
      }
    };

    let out = '';
    clans.forEach((clan, idx) => {
      const buckets = {
        leader: [],
        deputy: [],
        med: [],
        medApp: [],
        warriors: [],
        apprentices: [],
        queens: [],
        elders: [],
        kits: []
      };
      (clan.cats || []).forEach(cat => {
        const key = categorize(cat.rank);
        buckets[key].push({ name: cat.name || '(unnamed)', description: clean(cat.description) });
      });

  // Clan title only (no clan description in book style)
  out += `${clan.name || 'Unnamed Clan'}\n`;

      // Ordered sections
      const order = ['leader','deputy','med','medApp','warriors','apprentices','queens','elders','kits'];
      order.forEach(k => {
        const list = buckets[k];
        if (list && list.length) {
          const rendered = list.map(x => x.description ? `${x.name} â€” ${x.description}` : x.name);
          out += `${header(k, list.length)}: ${rendered.join(', ')}\n`;
        }
      });
      if (idx < clans.length - 1) out += '\n';
    });

    const text = out.trim() ? out : '(No clans or cats)';
    navigator.clipboard.writeText(text).then(() => {
      showToast('Book-style allegiances copied!', 'success');
    }).catch(() => {
      showToast('Failed to copy â€” try again.', 'error');
    });
  }

  // Toast helper
  function showToast(message, variant = 'info', timeoutMs = 2500) {
    if (!toastContainer) return;
    const t = document.createElement('div');
    t.className = `toast ${variant}`;
    const close = document.createElement('button');
    close.className = 'toast-close';
    close.innerHTML = 'Ã—';
    close.onclick = () => {
      if (t.parentNode) t.parentNode.removeChild(t);
    };
    const span = document.createElement('span');
    span.textContent = message;
    t.appendChild(close);
    t.appendChild(span);
    toastContainer.appendChild(t);
    if (timeoutMs > 0) {
      setTimeout(() => {
        if (t.parentNode) t.parentNode.removeChild(t);
      }, timeoutMs);
    }
  }

  // Confirm helper (returns Promise<boolean>)
  function uiConfirm(message, { okText = 'Confirm', cancelText = 'Cancel' } = {}) {
    return new Promise((resolve) => {
      confirmOverlay.classList.add('show');
      confirmOverlay.focus();
      confirmModal.innerHTML = `
        <h3 id="confirmTitle" style="margin:0 0 8px 0; text-align:center; letter-spacing:1.1px;">Please Confirm</h3>
        <p class="confirm-text">${escapeHtml(message)}</p>
        <div class="confirm-buttons">
          <button id="confirmCancelBtn">${escapeHtml(cancelText)}</button>
          <button id="confirmOkBtn">${escapeHtml(okText)}</button>
        </div>
      `;
      const cleanup = (result) => {
        confirmOverlay.classList.remove('show');
        confirmModal.innerHTML = '';
        resolve(result);
      };
      confirmOverlay.onclick = (e) => { if (e.target === confirmOverlay) cleanup(false); };
      document.addEventListener('keydown', function onKey(e){ if (e.key === 'Escape' && confirmOverlay.classList.contains('show')) { document.removeEventListener('keydown', onKey); cleanup(false);} });
      confirmModal.querySelector('#confirmOkBtn').onclick = () => cleanup(true);
      confirmModal.querySelector('#confirmCancelBtn').onclick = () => cleanup(false);
    });
  }

  // Bulk age adjustment for all living cats (does not modify deathAge)
  function bulkAge(delta) {
    let anyChanged = false;
    // Adjust living cats (allow negatives)
    clans.forEach(clan => {
      clan.cats.forEach(cat => {
        const current = Number.isFinite(cat.age) ? cat.age : Number(cat.age) || 0;
        const next = current + delta;
        if (next !== current) {
          cat.age = next;
          anyChanged = true;
        }
      });
    });
    // Adjust dead cats and potentially revive on age down
    for (let i = deadCats.length - 1; i >= 0; i--) {
      const dc = deadCats[i];
      const current = Number.isFinite(dc.age) ? dc.age : Number(dc.age) || 0;
      const next = current + delta;
      if (next !== current) {
        dc.age = next;
        anyChanged = true;
      }
      const threshold = Number.isFinite(dc?.deathThreshold)
        ? dc.deathThreshold
        : (Number.isFinite(dc?.ageAtDeath) ? dc.ageAtDeath : dc.deathAge);
      if (delta < 0 && Number.isFinite(threshold) && dc.age < threshold) {
        // Revive
        deadCats.splice(i, 1);
        const revived = {
          name: dc.name,
          rank: dc.rank,
          age: dc.age,
          image: dc.image,
          deathAge: threshold,
          description: dc.description,
        };
        let placed = false;
        if (Number.isInteger(dc.originalClanIndex) && dc.originalClanIndex >= 0 && dc.originalClanIndex < clans.length) {
          clans[dc.originalClanIndex].cats.push(revived);
          placed = true;
        } else if (dc.originalClanName) {
          const idx = clans.findIndex(c => c.name === dc.originalClanName);
          if (idx >= 0) {
            clans[idx].cats.push(revived);
            placed = true;
          }
        }
        if (!placed) {
          if (clans.length > 0) {
            clans[0].cats.push(revived);
          } else {
            clans.push({ name: 'Revived Clan', description: 'Auto-created for revived cats', image: (clanImages && clanImages[0]) || '', cats: [revived] });
          }
        }
      }
    }
    // Adjust unborn cats too
    unbornCats.forEach(uc => {
      const current = Number.isFinite(uc.age) ? uc.age : Number(uc.age) || 0;
      const next = current + delta;
      if (next !== current) {
        uc.age = next;
        anyChanged = true;
      }
    });
    if (anyChanged) {
      // Re-render (which will also move any cats between lists)
      renderAll();
    }
  }

  // Render functions
  function updateDeaths() {
    // Move any cats whose age >= deathAge into deadCats
    let movedCount = 0;
    clans.forEach((clan, clanIndex) => {
      const survivors = [];
      clan.cats.forEach((cat) => {
        const d = cat.deathAge;
        if (d !== null && d !== undefined && !isNaN(d) && Number.isFinite(d) && cat.age >= d) {
          // Record as a dead cat. Age at death is the cat's current age.
          deadCats.push({
            name: cat.name,
            rank: cat.rank,
            // Store explicitly both the recorded age of death and keep `deathAge` for compatibility
            ageAtDeath: cat.age,
            deathAge: cat.age,
            // Current age can continue to change via bulk aging
            age: cat.age,
            image: cat.image,
            description: cat.description,
            // metadata for potential revival
            originalClanIndex: clanIndex,
            originalClanName: clan.name,
            deathThreshold: d,
          });
          movedCount++;
        } else {
          survivors.push(cat);
        }
      });
      clan.cats = survivors;
    });
    return movedCount;
  }

  function renderAll() {
    // Apply transitions before drawing
    updateDeaths();
    updateUnborns();
    renderClans();
    renderDeadCats();
    renderUnbornCats();
  }

  // Move cats with age < 0 into unbornCats and move back to clans when age >= 0
  function updateUnborns() {
    // Move from clans to unborn if age < 0
    clans.forEach((clan, clanIndex) => {
      const survivors = [];
  clan.cats.forEach(cat => {
        const a = Number.isFinite(cat.age) ? cat.age : Number(cat.age) || 0;
        if (a < 0) {
          unbornCats.push({
            name: cat.name,
            rank: cat.rank,
            age: a, // can be negative
            image: cat.image,
            description: cat.description,
            originalClanIndex: clanIndex,
            originalClanName: clan.name,
    deathAge: cat.deathAge ?? null,
          });
        } else {
          survivors.push(cat);
        }
      });
      clan.cats = survivors;
    });

    // Move from unborn back to clans when age >= 0
    for (let i = unbornCats.length - 1; i >= 0; i--) {
      const uc = unbornCats[i];
      const a = Number.isFinite(uc.age) ? uc.age : Number(uc.age) || 0;
      if (a >= 0) {
        unbornCats.splice(i, 1);
        const newborn = {
          name: uc.name,
          rank: uc.rank,
          age: a,
          image: uc.image,
          deathAge: Number.isFinite(uc.deathAge) || uc.deathAge === null ? uc.deathAge : null,
          description: uc.description,
        };
        let placed = false;
        if (Number.isInteger(uc.originalClanIndex) && uc.originalClanIndex >= 0 && uc.originalClanIndex < clans.length) {
          clans[uc.originalClanIndex].cats.push(newborn);
          placed = true;
        } else if (uc.originalClanName) {
          const idx = clans.findIndex(c => c.name === uc.originalClanName);
          if (idx >= 0) {
            clans[idx].cats.push(newborn);
            placed = true;
          }
        }
        if (!placed) {
          if (clans.length > 0) {
            clans[0].cats.push(newborn);
          } else {
            clans.push({ name: 'Newborn Clan', description: 'Auto-created for unborn/newborn cats', image: (clanImages && clanImages[0]) || '', cats: [newborn] });
          }
        }
      }
    }
  }

  function renderClans() {
    clansContainer.innerHTML = '';
    if (clans.length === 0) {
      const emptyMsg = document.createElement('p');
      emptyMsg.style.color = '#b697c2';
      emptyMsg.style.textAlign = 'center';
      emptyMsg.style.width = '100%';
      emptyMsg.textContent = 'No clans yet â€” click "Add Clan" to create one!';
      clansContainer.appendChild(emptyMsg);
      return;
    }
  clans.forEach((clan, cIndex) => {
      const clanCard = document.createElement('div');
      clanCard.className = 'clan-card';

      const clanHeader = document.createElement('div');
      clanHeader.className = 'clan-header';

      const clanImg = document.createElement('img');
      clanImg.src = clan.image || clanImages[0];
      clanImg.alt = `${clan.name} emblem`;

      const clanName = document.createElement('h2');
      clanName.textContent = clan.name;

      clanHeader.appendChild(clanImg);
      clanHeader.appendChild(clanName);

      // Clan description
      const clanDesc = document.createElement('div');
      clanDesc.className = 'clan-description';
      clanDesc.textContent = clan.description || 'No description provided.';

      // Cats list
      const catsList = document.createElement('div');
      catsList.className = 'cats-list';

      // Allow dropping into empty space (append to end)
      catsList.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        catsList.classList.add('drop-target');
      });
      catsList.addEventListener('dragleave', () => {
        catsList.classList.remove('drop-target');
      });
      catsList.addEventListener('drop', (e) => {
        e.preventDefault();
        catsList.classList.remove('drop-target');
        const payload = e.dataTransfer.getData('text/plain');
        if (!payload) return;
        try {
          const { fromClan, fromIndex } = JSON.parse(payload);
          if (typeof fromClan !== 'number' || typeof fromIndex !== 'number') return;
          const toClan = cIndex;
          const toIndex = clan.cats.length; // append to end
          if (moveCat(fromClan, fromIndex, toClan, toIndex)) {
            renderAll();
          }
        } catch (_) {}
      });

      clan.cats.forEach((cat, catIndex) => {
        const catItem = document.createElement('div');
        catItem.className = 'cat-item';
        catItem.draggable = true;
        catItem.dataset.clanIndex = String(cIndex);
        catItem.dataset.catIndex = String(catIndex);

        // DnD handlers
        catItem.addEventListener('dragstart', (e) => {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', JSON.stringify({ fromClan: cIndex, fromIndex: catIndex }));
          catItem.classList.add('dragging');
        });
        catItem.addEventListener('dragend', () => {
          catItem.classList.remove('dragging');
        });
        catItem.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          catItem.classList.add('drag-over');
        });
        catItem.addEventListener('dragleave', () => {
          catItem.classList.remove('drag-over');
        });
        catItem.addEventListener('drop', (e) => {
          e.preventDefault();
          catItem.classList.remove('drag-over');
          const payload = e.dataTransfer.getData('text/plain');
          if (!payload) return;
          try {
            const { fromClan, fromIndex } = JSON.parse(payload);
            if (typeof fromClan !== 'number' || typeof fromIndex !== 'number') return;
            const toClan = cIndex;
            // Decide insertion before/after based on cursor position
            const rect = catItem.getBoundingClientRect();
            const before = e.clientY < rect.top + rect.height / 2;
            let toIndex = catIndex + (before ? 0 : 1);
            if (moveCat(fromClan, fromIndex, toClan, toIndex)) {
              renderAll();
            }
          } catch (_) {}
        });

        const catImg = document.createElement('img');
        catImg.src = cat.image || catImages[0];
        catImg.alt = cat.name;

        const catInfo = document.createElement('div');
        catInfo.className = 'cat-info';

        const catName = document.createElement('div');
        catName.className = 'cat-name';
        catName.textContent = cat.name;

  const catRankAge = document.createElement('div');
        catRankAge.className = 'cat-rank-age';
        catRankAge.textContent = `${cat.rank} â€” Age: ${cat.age}`;
  const catDesc = document.createElement('div');
  catDesc.className = 'cat-description';
  catDesc.textContent = cat.description && cat.description.trim() ? cat.description : 'No description provided.';

        catInfo.appendChild(catName);
        catInfo.appendChild(catRankAge);
  catInfo.appendChild(catDesc);

        // Edit Cat button
        const editCatBtn = document.createElement('button');
        editCatBtn.textContent = 'Edit Cat';
        editCatBtn.title = `Edit ${cat.name}`;
        editCatBtn.onclick = () => openCatModal(cIndex, catIndex);

        catItem.appendChild(catImg);
        catItem.appendChild(catInfo);
        catItem.appendChild(editCatBtn);

        catsList.appendChild(catItem);
      });

      // Add Cat button
      const addCatBtn = document.createElement('button');
      addCatBtn.className = 'add-cat-btn';
      addCatBtn.textContent = '+ Add Cat';
      addCatBtn.title = `Add a new cat to ${clan.name}`;
      addCatBtn.onclick = () => openCatModal(cIndex);

      clanCard.appendChild(clanHeader);
      clanCard.appendChild(clanDesc);
      clanCard.appendChild(catsList);
      clanCard.appendChild(addCatBtn);

      // Clan footer with Edit Clan button
      const clanFooter = document.createElement('div');
      clanFooter.className = 'clan-footer';

      const editClanBtn = document.createElement('button');
      editClanBtn.textContent = 'Edit Clan';
      editClanBtn.onclick = () => openClanModal(cIndex);

      const deleteClanBtn = document.createElement('button');
      deleteClanBtn.textContent = 'Delete Clan';
      deleteClanBtn.style.borderColor = '#d94f4f';
      deleteClanBtn.style.color = '#d94f4f';
      deleteClanBtn.onmouseenter = () => {
        deleteClanBtn.style.background = '#d94f4f';
        deleteClanBtn.style.color = '#121212';
      };
      deleteClanBtn.onmouseleave = () => {
        deleteClanBtn.style.background = 'transparent';
        deleteClanBtn.style.color = '#d94f4f';
      };
      deleteClanBtn.onclick = async () => {
        const ok = await uiConfirm(`Delete clan "${clan.name}"? This will also remove all its cats.`, { okText: 'Delete', cancelText: 'Cancel' });
        if (ok) {
          clans.splice(cIndex, 1);
          renderAll();
          showToast('Clan deleted', 'warning');
        }
      };

      clanFooter.appendChild(editClanBtn);
      clanFooter.appendChild(deleteClanBtn);

      clanCard.appendChild(clanFooter);

      clansContainer.appendChild(clanCard);
    });
  }

  // Move a cat between/within clans safely
  function moveCat(fromClanIdx, fromCatIdx, toClanIdx, toCatIdx) {
    if (
      fromClanIdx < 0 || fromClanIdx >= clans.length ||
      toClanIdx < 0 || toClanIdx >= clans.length
    ) return false;
    const fromCats = clans[fromClanIdx].cats;
    const toCats = clans[toClanIdx].cats;
    if (
      fromCatIdx < 0 || fromCatIdx >= fromCats.length
    ) return false;
    // Clamp to index
    if (toCatIdx < 0) toCatIdx = 0;
    if (toCatIdx > toCats.length) toCatIdx = toCats.length;
    const [moved] = fromCats.splice(fromCatIdx, 1);
    if (!moved) return false;
    if (fromClanIdx === toClanIdx && fromCatIdx < toCatIdx) {
      toCatIdx -= 1; // account for removal shift within same list
    }
    toCats.splice(toCatIdx, 0, moved);
    return true;
  }

  function renderDeadCats() {
    deadCatsContainer.innerHTML = '';
    if (deadCats.length === 0) {
      const emptyMsg = document.createElement('p');
      emptyMsg.style.color = '#b697c2';
      emptyMsg.style.textAlign = 'center';
      emptyMsg.style.width = '100%';
      emptyMsg.textContent = 'No dead cats.';
      deadCatsContainer.appendChild(emptyMsg);
      return;
    }
    deadCats.forEach((cat, index) => {
      const deadCard = document.createElement('div');
      deadCard.className = 'dead-card';

      const catImg = document.createElement('img');
      catImg.src = cat.image || catImages[0];
      catImg.alt = cat.name;

  const deadInfo = document.createElement('div');
      deadInfo.className = 'dead-info';

      const deadName = document.createElement('div');
      deadName.className = 'dead-name';
      deadName.textContent = cat.name;

  const deadRankAge = document.createElement('div');
  deadRankAge.className = 'dead-rank-age';
  const ageAtDeath = Number.isFinite(cat.ageAtDeath) ? cat.ageAtDeath : cat.deathAge;
  deadRankAge.textContent = `${cat.rank} â€” Age at death: ${ageAtDeath}`;

  const deadAgeDeathAge = document.createElement('div');
  deadAgeDeathAge.className = 'dead-age-deathage';
  deadAgeDeathAge.textContent = `Current age: ${cat.age}`;

      const deadDesc = document.createElement('div');
      deadDesc.className = 'dead-description';
      deadDesc.textContent = cat.description && cat.description.trim() ? cat.description : 'No description provided.';

      deadInfo.appendChild(deadName);
      deadInfo.appendChild(deadRankAge);
  deadInfo.appendChild(deadAgeDeathAge);
  deadInfo.appendChild(deadDesc);

      const editDeadBtn = document.createElement('button');
      editDeadBtn.textContent = 'Edit';
      editDeadBtn.title = `Edit ${cat.name} (Revive by editing death age)`;
      editDeadBtn.onclick = () => openDeadCatModal(index);

      deadCard.appendChild(catImg);
      deadCard.appendChild(deadInfo);
      deadCard.appendChild(editDeadBtn);

      deadCatsContainer.appendChild(deadCard);
    });
  }

  function renderUnbornCats() {
    unbornCatsContainer.innerHTML = '';
    if (unbornCats.length === 0) {
      const emptyMsg = document.createElement('p');
      emptyMsg.style.color = '#b697c2';
      emptyMsg.style.textAlign = 'center';
      emptyMsg.style.width = '100%';
      emptyMsg.textContent = 'No unborn cats.';
      unbornCatsContainer.appendChild(emptyMsg);
      return;
    }
    unbornCats.forEach((cat, index) => {
      const card = document.createElement('div');
      card.className = 'unborn-card';

      const img = document.createElement('img');
      img.src = cat.image || catImages[0];
      img.alt = cat.name;

      const info = document.createElement('div');
      info.className = 'unborn-info';

      const nameEl = document.createElement('div');
      nameEl.className = 'unborn-name';
      nameEl.textContent = cat.name || '(Unnamed)';

  const ageEl = document.createElement('div');
      ageEl.className = 'unborn-age';
      ageEl.textContent = `Current age: ${cat.age}`;

  const descEl = document.createElement('div');
  descEl.className = 'unborn-description';
  descEl.textContent = cat.description && cat.description.trim() ? cat.description : 'No description provided.';

      info.appendChild(nameEl);
  info.appendChild(ageEl);
  info.appendChild(descEl);

      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.title = `Edit ${cat.name || 'unborn cat'}`;
      editBtn.onclick = () => openUnbornCatModal(index);

      card.appendChild(img);
      card.appendChild(info);
      card.appendChild(editBtn);

      unbornCatsContainer.appendChild(card);
    });
  }

  // Modal handling
  let modalMode = null; // 'clan' or 'cat' or 'deadCat'
  let editClanIndex = null;
  let editCatIndices = { clanIndex: null, catIndex: null };
  let editDeadCatIndex = null;

  function openModal() {
    modalOverlay.classList.add('show');
    modalOverlay.focus();
  }
  function closeModal() {
    modalOverlay.classList.remove('show');
    modal.innerHTML = '';
    modalMode = null;
    editClanIndex = null;
    editCatIndices = { clanIndex: null, catIndex: null };
    editDeadCatIndex = null;
  }

  modalOverlay.addEventListener('click', e => {
    if (e.target === modalOverlay) closeModal();
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && modalOverlay.classList.contains('show')) {
      closeModal();
    }
  });

  // Clan modal
  function openClanModal(cIndex = null) {
    modalMode = 'clan';
    editClanIndex = cIndex;

    const clan = cIndex !== null ? clans[cIndex] : { name: '', description: '', image: clanImages[0], cats: [] };

    modal.innerHTML = `
      <h3 id="modalTitle">${cIndex === null ? 'Add Clan' : 'Edit Clan'}</h3>
      <label for="clanName">Clan Name</label>
      <input type="text" id="clanName" value="${escapeHtml(clan.name)}" placeholder="Enter clan name" required />
      <label for="clanDescription">Description</label>
      <textarea id="clanDescription" rows="3" placeholder="Description (optional)">${escapeHtml(clan.description)}</textarea>
      <label>Choose Emblem</label>
      <div class="img-picker" id="clanImagePicker"></div>
      <div class="img-upload">
        <button id="clanUploadBtn" type="button" aria-label="Upload custom clan image">Upload Imageâ€¦</button>
        <input id="clanUploadInput" type="file" accept="image/*" style="display:none" />
      </div>
      <div class="modal-buttons">
        <button id="clanSaveBtn">${cIndex === null ? 'Create' : 'Save'}</button>
        <button id="clanCancelBtn">Cancel</button>
      </div>
    `;

    const picker = modal.querySelector('#clanImagePicker');
    clanImages.forEach(imgUrl => {
      const img = document.createElement('img');
      img.src = imgUrl;
      if (imgUrl === clan.image) img.classList.add('selected');
      img.onclick = () => {
        picker.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
      };
      picker.appendChild(img);
    });

  // Upload wiring for clan image
  const clanUploadInput = modal.querySelector('#clanUploadInput');
  const clanUploadBtn = modal.querySelector('#clanUploadBtn');
  clanUploadBtn.onclick = () => clanUploadInput.click();
  clanUploadInput.onchange = (e) => handleImageUpload(e, picker);

    modal.querySelector('#clanSaveBtn').onclick = () => {
      const name = modal.querySelector('#clanName').value.trim();
      const desc = modal.querySelector('#clanDescription').value.trim();
      const selectedImg = picker.querySelector('img.selected');
  if (!name) { showToast('Clan name is required.', 'error'); return; }
      const image = selectedImg ? selectedImg.src : clanImages[0];

      if (cIndex === null) {
        clans.push({ name, description: desc, image, cats: [] });
      } else {
        clans[cIndex].name = name;
        clans[cIndex].description = desc;
        clans[cIndex].image = image;
      }
      closeModal();
      renderAll();
    };

    modal.querySelector('#clanCancelBtn').onclick = closeModal;

    openModal();
  }

  // Cat modal (for add and edit)
  function openCatModal(clanIndex, catIndex = null) {
    modalMode = 'cat';
    editCatIndices = { clanIndex, catIndex };

    const clan = clans[clanIndex];
  const cat = catIndex !== null ? clan.cats[catIndex] : { name: '', rank: '', age: 1, image: catImages[0], deathAge: null, description: '' };

    modal.innerHTML = `
      <h3 id="modalTitle">${catIndex === null ? 'Add Cat' : 'Edit Cat'}</h3>
      <label for="catName">Name</label>
      <input type="text" id="catName" value="${escapeHtml(cat.name)}" placeholder="Cat's name" required />
      <label for="catRank">Rank</label>
      <input type="text" id="catRank" value="${escapeHtml(cat.rank)}" placeholder="Rank (e.g., warrior, apprentice)" />
  <label for="catDescription">Description</label>
  <textarea id="catDescription" rows="3" placeholder="Description (optional)">${escapeHtml(cat.description || '')}</textarea>
  <label for="catAge">Age</label>
  <input type="number" id="catAge" value="${cat.age}" />
  <label for="catDeathAge">Death Age (optional)</label>
  <input type="number" id="catDeathAge" value="${cat.deathAge ?? ''}" min="0" placeholder="e.g., 12" />
      <label>Choose Image</label>
      <div class="img-picker" id="catImagePicker"></div>
      <div class="img-upload">
        <button id="catUploadBtn" type="button" aria-label="Upload custom cat image">Upload Imageâ€¦</button>
        <input id="catUploadInput" type="file" accept="image/*" style="display:none" />
      </div>
      <div class="modal-buttons">
        <button id="catSaveBtn">${catIndex === null ? 'Add' : 'Save'}</button>
        <button id="catCancelBtn">Cancel</button>
        ${catIndex !== null ? '<button id="catDeleteBtn" style="margin-left: auto; background: #d94f4f; color: #121212;">Delete</button>' : ''}
      </div>
    `;

    const picker = modal.querySelector('#catImagePicker');
    catImages.forEach(imgUrl => {
      const img = document.createElement('img');
      img.src = imgUrl;
      if (imgUrl === cat.image) img.classList.add('selected');
      img.onclick = () => {
        picker.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
      };
      picker.appendChild(img);
    });

  // Upload wiring for cat image
  const catUploadInput = modal.querySelector('#catUploadInput');
  const catUploadBtn = modal.querySelector('#catUploadBtn');
  catUploadBtn.onclick = () => catUploadInput.click();
  catUploadInput.onchange = (e) => handleImageUpload(e, picker);

    modal.querySelector('#catSaveBtn').onclick = () => {
      const name = modal.querySelector('#catName').value.trim();
      const rank = modal.querySelector('#catRank').value.trim();
  const age = parseInt(modal.querySelector('#catAge').value, 10);
  const description = modal.querySelector('#catDescription').value.trim();
      const deathAgeStr = modal.querySelector('#catDeathAge').value;
      const deathAge = deathAgeStr === '' ? null : parseInt(deathAgeStr, 10);
      const selectedImg = picker.querySelector('img.selected');
  if (!name) { showToast('Cat name is required.', 'error'); return; }
  if (isNaN(age)) { showToast('Age must be a number.', 'error'); return; }
  if (deathAge !== null && (isNaN(deathAge) || deathAge < 0)) { showToast('Death age must be empty or a non-negative number.', 'error'); return; }
      const image = selectedImg ? selectedImg.src : catImages[0];

      if (catIndex === null) {
        clans[clanIndex].cats.push({ name, rank, age, image, deathAge, description });
      } else {
        clans[clanIndex].cats[catIndex].name = name;
        clans[clanIndex].cats[catIndex].rank = rank;
        clans[clanIndex].cats[catIndex].age = age;
        clans[clanIndex].cats[catIndex].image = image;
        clans[clanIndex].cats[catIndex].deathAge = deathAge;
        clans[clanIndex].cats[catIndex].description = description;
      }
      closeModal();
      renderAll();
    };

    modal.querySelector('#catCancelBtn').onclick = closeModal;

    if (catIndex !== null) {
      modal.querySelector('#catDeleteBtn').onclick = async () => {
        const ok = await uiConfirm(`Delete cat "${cat.name}"?`, { okText: 'Delete' });
        if (ok) {
          clans[clanIndex].cats.splice(catIndex, 1);
          closeModal();
          renderAll();
          showToast('Cat deleted', 'warning');
        }
      };
    }

    openModal();
  }

  // Dead Cat modal
  function openDeadCatModal(deadIndex) {
    modalMode = 'deadCat';
    editDeadCatIndex = deadIndex;

    const deadCat = deadCats[deadIndex];

    modal.innerHTML = `
      <h3 id="modalTitle">Edit Dead Cat</h3>
      <label for="deadCatName">Name</label>
      <input type="text" id="deadCatName" value="${escapeHtml(deadCat.name)}" placeholder="Name" required />
      <label for="deadCatRank">Rank</label>
      <input type="text" id="deadCatRank" value="${escapeHtml(deadCat.rank)}" placeholder="Rank" />
      <label for="deadCatAgeAtDeath">Age at Death</label>
      <input type="number" id="deadCatAgeAtDeath" value="${Number.isFinite(deadCat.ageAtDeath) ? deadCat.ageAtDeath : deadCat.deathAge}" min="0" />
  <label for="deadCatDescription">Description</label>
  <textarea id="deadCatDescription" rows="3" placeholder="Description (optional)">${escapeHtml(deadCat.description || '')}</textarea>
      <label for="deadCatCurrentAge">Current age</label>
  <input type="number" id="deadCatCurrentAge" value="${deadCat.age}" />
      <label>Choose Image</label>
      <div class="img-picker" id="deadCatImagePicker"></div>
      <div class="modal-buttons">
        <button id="deadCatSaveBtn">Save</button>
        <button id="deadCatCancelBtn">Cancel</button>
        <button id="deadCatDeleteBtn" style="margin-left: auto; background: #d94f4f; color: #121212;">Delete</button>
      </div>
    `;

    const picker = modal.querySelector('#deadCatImagePicker');
    catImages.forEach(imgUrl => {
      const img = document.createElement('img');
      img.src = imgUrl;
      if (imgUrl === deadCat.image) img.classList.add('selected');
      img.onclick = () => {
        picker.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
      };
      picker.appendChild(img);
    });

    modal.querySelector('#deadCatSaveBtn').onclick = () => {
      const name = modal.querySelector('#deadCatName').value.trim();
      const rank = modal.querySelector('#deadCatRank').value.trim();
      const ageAtDeath = parseInt(modal.querySelector('#deadCatAgeAtDeath').value, 10);
      const currentAge = parseInt(modal.querySelector('#deadCatCurrentAge').value, 10);
  const selectedImg = picker.querySelector('img.selected');
  const description = modal.querySelector('#deadCatDescription').value.trim();
  if (!name) { showToast('Name is required.', 'error'); return; }
  if (isNaN(ageAtDeath) || ageAtDeath < 0) { showToast('Age at death must be a non-negative number.', 'error'); return; }
  if (isNaN(currentAge)) { showToast('Current age must be a number.', 'error'); return; }
      const image = selectedImg ? selectedImg.src : catImages[0];

      // Preserve metadata fields if present
      const prev = deadCats[editDeadCatIndex] || {};
      deadCats[editDeadCatIndex] = {
        name,
        rank,
        ageAtDeath,
        // keep legacy field for UI that references deathAge
        deathAge: ageAtDeath,
        age: currentAge,
        image,
        description,
        originalClanIndex: prev.originalClanIndex,
        originalClanName: prev.originalClanName,
        deathThreshold: Number.isFinite(prev?.deathThreshold) ? prev.deathThreshold : ageAtDeath,
      };
      closeModal();
      renderAll();
    };

    modal.querySelector('#deadCatCancelBtn').onclick = closeModal;

    modal.querySelector('#deadCatDeleteBtn').onclick = async () => {
      const ok = await uiConfirm(`Delete dead cat "${deadCat.name}"?`, { okText: 'Delete' });
      if (ok) {
        deadCats.splice(editDeadCatIndex, 1);
        closeModal();
        renderAll();
        showToast('Dead cat removed', 'warning');
      }
    };

    openModal();
  }

  // Unborn Cat modal
  function openUnbornCatModal(unbornIndex) {
    const unborn = unbornCats[unbornIndex];
    modalMode = 'unbornCat';
    modal.innerHTML = `
      <h3 id="modalTitle">Edit Unborn Cat</h3>
      <label for="unbornName">Name</label>
      <input type="text" id="unbornName" value="${escapeHtml(unborn.name || '')}" placeholder="Name (optional)" />
      <label for="unbornRank">Rank</label>
      <input type="text" id="unbornRank" value="${escapeHtml(unborn.rank || '')}" placeholder="Rank (optional)" />
  <label for="unbornDescription">Description</label>
  <textarea id="unbornDescription" rows="3" placeholder="Description (optional)">${escapeHtml(unborn.description || '')}</textarea>
      <label for="unbornAge">Current age (can be negative)</label>
      <input type="number" id="unbornAge" value="${unborn.age}" />
      <label>Choose Image</label>
      <div class="img-picker" id="unbornImagePicker"></div>
      <div class="modal-buttons">
        <button id="unbornSaveBtn">Save</button>
        <button id="unbornCancelBtn">Cancel</button>
        <button id="unbornDeleteBtn" style="margin-left: auto; background: #d94f4f; color: #121212;">Delete</button>
      </div>
    `;

    const picker = modal.querySelector('#unbornImagePicker');
    catImages.forEach(imgUrl => {
      const img = document.createElement('img');
      img.src = imgUrl;
      if (imgUrl === unborn.image) img.classList.add('selected');
      img.onclick = () => {
        picker.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
      };
      picker.appendChild(img);
    });

    modal.querySelector('#unbornSaveBtn').onclick = () => {
      const name = modal.querySelector('#unbornName').value.trim();
      const rank = modal.querySelector('#unbornRank').value.trim();
  const ageStr = modal.querySelector('#unbornAge').value;
  const description = modal.querySelector('#unbornDescription').value.trim();
      const age = parseFloat(ageStr);
  if (isNaN(age)) { showToast('Age must be a number (can be negative).', 'error'); return; }
      const selectedImg = picker.querySelector('img.selected');
      const image = selectedImg ? selectedImg.src : (unborn.image || catImages[0]);
      unbornCats[unbornIndex] = {
        ...unborn,
        name: name || unborn.name,
        rank: rank || unborn.rank,
        age: age,
  image,
  description,
      };
      closeModal();
      renderAll();
    };

    modal.querySelector('#unbornCancelBtn').onclick = closeModal;
    modal.querySelector('#unbornDeleteBtn').onclick = async () => {
      const ok = await uiConfirm(`Delete unborn cat "${unborn.name || '(Unnamed)'}"?`, { okText: 'Delete' });
      if (ok) {
        unbornCats.splice(unbornIndex, 1);
        closeModal();
        renderAll();
        showToast('Unborn cat removed', 'warning');
      }
    };

    openModal();
  }

  // Escape HTML helper
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => {
      switch (m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // Shared handler to read an uploaded image and add/select it in a picker
  async function handleImageUpload(event, pickerEl) {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    if (!file.type || !file.type.startsWith('image/')) {
  showToast('Please choose a valid image file.', 'error');
      event.target.value = '';
      return;
    }
    // Optional soft guard for very large files that may exceed localStorage limits
    const MAX_SIZE_BYTES = 2.5 * 1024 * 1024; // ~2.5MB
    if (file.size > MAX_SIZE_BYTES) {
      const ok = await uiConfirm('This image is quite large and may not save correctly. Continue?', { okText: 'Continue' });
      if (!ok) { event.target.value = ''; return; }
    }
    const reader = new FileReader();
    reader.onload = () => {
      const url = reader.result;
      const img = document.createElement('img');
      img.src = url;
      // select behavior
      img.onclick = () => {
        pickerEl.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
      };
      // insert at the front and select it
      pickerEl.insertBefore(img, pickerEl.firstChild);
      pickerEl.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
      img.classList.add('selected');
      event.target.value = '';
    };
    reader.onerror = () => {
      alert('Failed to read image. Please try a different file.');
      event.target.value = '';
    };
    reader.readAsDataURL(file);
  }

  // Button events
  document.getElementById('addClanBtn').onclick = () => openClanModal();
  document.getElementById('saveBtn').onclick = openSaveModal;
  document.getElementById('loadBtn').onclick = openLoadModal;
  document.getElementById('copyBtn').onclick = copyAllegiances;
  document.getElementById('copyBookBtn').onclick = copyAllegiancesBookStyle;
  document.getElementById('ageUpBtn').onclick = () => bulkAge(1);
  document.getElementById('ageDownBtn').onclick = () => bulkAge(-1);

  // Initial render
  renderAll();
</script>

</body>
</html>